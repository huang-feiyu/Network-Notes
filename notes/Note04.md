# Chapter 4: 网络层

[TOC]

### 概述

网络层：主机到主机的通信，仅检查通过该节点的 IP 数据报头部

* 向前转发（forwarding）：将数据报从路由的输入端口向前转发到相应的输出端口
  * 转发表
* 路由（routing）：决定数据报从源到目的地所经过的路径
  * 路由算法

网络服务模型：定义网络的一端到另一端之间分组的端到端传输特性（Internet "best effort"）

### 虚电路和数据报网络

* VC 网络，网络层连接服务（面向主机）
  * 每个 VC 路由都维护连接状态信息
* **数据报网络**，网络层无连接服务
  * 前向转发表：［地域决定的］地址块（最长前缀匹配）
  * 好处：链路类型多样，"smart" 端系统

### 路由结构

关键的路由功能：

* 运行路由算法
* 从 入端口 到 出端口 链路*前向转发* 数据报

```
               +------------------+
input ports -> | switching fabric | -> output ports
               +------------------+
                       ^
                       |
                       V
                routing processor
```

* *输入端口* 通过分布式交换与给定数据报目的地址，在输入端口缓存的前向转发表查找*输出端口*
  * 内存交换：在通用计算机 CPU 控制下完成交换
  * 总线交换：输入端口经总线将数据报传送到输出端口
  * 互联网络交换：突破总线带宽的限制
* 输出端口：缓存数据报、调度策略（选择优先数据报）

### IP 协议

```
+-------------------------------------+
| Routing protocols & fowarding table |
|       IP protocol & ICMP protocol   |
+-------------------------------------+
```

##### 数据报格式

IP 数据报格式：

* IP 协议版本号
* 首部长度
* 服务类型
* 数据报长度
* 16 比特标识位、标志位、偏移量
* 寿命（每一跳减 1）
* 上层协议
* 头部 checksum
* 源 IP 地址
* 目的 IP 地址
* 数据（一般是 TCP 或 UDP 报文段）

大的 IP 数据报分片为多个较小的数据报，在目的主机重组（IP 头部字段用于表示和重组）

##### IP 寻址

IP 地址：32-bit 主机/路由器**接口**的标识（接口：host/router 和 物理链路的连接）

223.1.3.0/24：前 24 位标识子网，后 8 位标识主机

IP 地址：CIDR（Classless InterDomain Routing），无类别域间选路

IP 分配：DHCP，动态主机配置协议（从 DHCP 服务器处动态地获得 IP 地址、子网掩码、第一跳路由器-网关）

层次寻址：路由汇聚

ICANN -> ISP -> 单位 -> 主机

##### NAT 网络地址转换

192 开头 => 内网

NAT 网络地址转换：

* 内部网络只使用一个外部 IP 地址
* 可以在机构内部更改 IP 地址
* 可以更换 ISP
* 内网设备无法直接寻址，将内网和外网隔离开来

NAT 路由器：

1. 对于外出的数据报，替换源 IP 和端口号 为 NAT IP 和端口号
1. 记录转换关系到 NAT 转换表中
1. 对每个进入的数据报，替换 NAT 地址为主机地址（根据 NAT 表）

##### ICMP

ICMP 互联网控制报文协议：

* 用于主机和路由器交换网络层信息
* 层次 "above" IP：ICMP msgs 承载于 IP 数据报

##### IPv6

128 位地址，首部用于前向转发

数据报格式：固定 40 字节首部，不允许分片

隧道：将 IPv6 数据报作为 IPv4 的负载在 IPv4 路由器中流动

### Internet 路由

AS 内部选路：内部网关协议（IGP）

* RIP：Routing Information Protocol，选路信息协议（类 DV 算法，距离向量算法）
  * 底层 ISP，企业网
* OSPF：Open Shortest Path First（Dijkstra 算法）
  * 顶层 ISP

